steps:
  build:
    image: voidcontext/woodpecker-plugin-nix-attic:0.2.0
    settings:
      binary_cache: https://cache.lukasl.dev/pollux
      binary_cache_public_key: pollux:F7WHpedmr4qMZ1Asg0XYQfJ1xShcL+MINf5FwrgBcwg=
      binary_cache_token:
        from_secret: binary_cache_access_token
      script: |
        attic login attic $PLUGIN_BINARY_CACHE $PLUGIN_BINARY_CACHE_TOKEN
        attic use attic:pollux
        nix build .#nixosConfigurations.pollux.config.system.build.toplevel
        attic push attic:pollux $(nix path-info .#nixosConfigurations.pollux.config.system.build.toplevel)

when:
  - event: [push, pull_request]
    path:
      - ".woodpecker/pollux.yaml"
      - "planets/pollux/**"
      - "options/**"
      - "packages/**"
      - "flake.nix"
      - "flake.lock"
